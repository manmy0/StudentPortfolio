@page
@model StudentPortfolio.Pages.Competencies.CompetenciesModel

@{
    ViewData["Title"] = "Competencies";
}

@section CompetenciesNav {
    <li class="nav-item">
        <a class="nav-link active" aria-current="page" asp-page="/Competencies/Competencies">Competencies</a>
    </li>
}

@if (Model.DiscontinuedCompetencies.Count() > 0 && Model.From == null && Model.To == null)
{
    <p style="font-size: 18px; line-height: 1.75; font-weight: 600;">You have entries for <b>discontinued competencies</b>.<br /> Go to the bottom of the page to export and delete your entries.</p>
}

<div class="input-container mb-3">
    <h3>Date Range</h3>
    <form method="get" class="d-flex align-items-center gap-3">
        <label for="fromInput">From:</label>
        <input class="form-control w-auto" type="month" id="fromInput" name="from" value="@Model.From">

        <label for="toInput">To:</label>
        <input class="form-control w-auto" type="month" id="toInput" name="to" value="=@Model.To">

        <button type="submit" class="btn btn-primary">Filter</button>

        @if (Model.From != null && Model.To != null)
        {
            <a asp-page="Competencies" class="btn btn-secondary">Clear</a>
        }
    </form>
</div>

<table class="table table-bordered table-striped collapsible-table">
    @foreach (var parentComp in Model.ParentCompetencies)
    {
        <thead>
            <tr>
                <th></th>
                <th>
                    @Html.DisplayFor(modelItem => parentComp.Description)
                </th>
                <th>
                    Link to Indicators
                </th>
                <th>
                    Level
                </th>
                <th>
                    Start Date
                </th>
                <th>
                    End Date
                </th>
                <th>
                    Skill Review
                </th>
                <th>
                    Evidence
                </th>
                <th></th>
                <th></th>
            </tr>
        </thead>

        @foreach (var comp in Model.Competencies.Where(c => c.ParentCompetencyId == parentComp.CompetencyId))
        {
            if (Model.CompetencyTracker.Where(t => t.CompetencyId == comp.CompetencyId).Count() != 0)
            {
                var tracker = Model.CompetencyTracker.Where(t => t.CompetencyId == comp.CompetencyId);
                var mainTracker = tracker.First();

                <tbody class="master-row">
                    <tr>
                        <td>
                            @Html.DisplayFor(modelItem => comp.CompetencyDisplayId)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => comp.Description)
                        </td>
                        <td>
                            <a href="@Html.DisplayFor(modelItem => comp.LinkToIndicators)">Indicators</a>
                        </td>
                        <td>
                            @mainTracker.Level.Name
                        </td>
                        <td>
                            @mainTracker.StartDate
                        </td>
                        <td>
                            @mainTracker.EndDate
                        </td>
                        <td>
                            @mainTracker.SkillsReview
                        </td>
                        <td>
                            <a href="@mainTracker.Evidence">Evidence</a>
                        </td>
                        <td>
                            <div class="icon-display">
                                <a asp-page="CreateCompetency" asp-route-competencyId="@comp.CompetencyId">
                                    <img src="~/img/plus-black-symbol.png" style="height: 30px; width: 30px; margin-right: 13px;" alt="Edit Competency" title="Add Entry">
                                </a>

                                <a asp-page="EditCompetency" asp-route-competencyTrackerId="@mainTracker.CompetencyTrackerId">
                                    <img src="~/img/edit-icon-png-3602.png" style="height: 30px; width: 30px;" alt="Edit Entry" title="Edit Entry">
                                </a>

                                @* Hides the delete button if the entries have been filtered by year so that lower levels can't be deleted *@
                                @if (Model.From == null && Model.To == null)
                                {
                                    <form asp-page-handler="Delete" method="post" asp-route-id="@mainTracker.CompetencyTrackerId" onsubmit="return confirm('Are you sure you want to delete this competency entry?');">
                                        <button class="delete-button" type="submit" title="Delete Entry">
                                            <img src="~/img/garbage-bin-png-10491.png" style="height: 40px; width: 40px;" alt="Delete Entry">
                                        </button>
                                    </form>
                                }
                            </div>

                            @if (Model.Feedbacks != null && Model.Feedbacks.Any(i => i.CompetencyTrackerId == mainTracker.CompetencyTrackerId))
                            {
                                // 1. Filter the feedback for the current competency
                                var compFeedbacks = Model.Feedbacks
                                .Where(i => i.CompetencyTrackerId == mainTracker.CompetencyTrackerId)
                                .ToList();

                                // 2. Project the data into a simpler format for JSON serialization
                                var dataToSerialize = compFeedbacks.Select(f => new
                                {
                                    FeedbackText = f.FeedbackText,
                                    DateCreated = f.DateCreated.ToString("yyyy-MM-dd"), // Format date
                                    Reviewer = f.User != null ? f.User.FirstName + " " + f.User.LastName : "Unknown Reviewer"
                                });

                                // 3. Serialize the simplified data
                                var jsonFeedbacks = System.Text.Json.JsonSerializer.Serialize(dataToSerialize);

                                <div class="feedback-button-container">
                                    <button type="button"
                                            class="feedback-button"
                                            data-bs-toggle="modal"
                                            data-bs-target="#feedbackModal"
                                            data-goal-description="@comp.Description" {{-- Using 'data-goal-description' as a generic description --}}
                                            data-feedbacks="@jsonFeedbacks">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-4z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                                    </button>
                                </div>
                            }
                        </td>
                        <td>
                            @if (tracker.Count() > 1)
                            {
                                <button class="toggle-details">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v13M5 12l7 7 7-7" /></svg>
                                </button>
                            }
                        </td>
                    </tr>
                </tbody>
                <tbody class="collapsible-content" style="display: none;">
                    @foreach (var level in tracker)
                    {
                        <tr>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td>
                                @level.Level.Name
                            </td>
                            <td>
                                @level.StartDate
                            </td>
                            <td>
                                @level.EndDate
                            </td>
                            <td>
                                @level.SkillsReview
                            </td>
                            <td>
                                <a href="@level.Evidence">Evidence</a>
                            </td>
                            <td>
                                <div class="icon-display">
                                    <a asp-page="EditCompetency" asp-route-competencyTrackerId="@level.CompetencyTrackerId">
                                        <img src="~/img/edit-icon-png-3602.png" style="height: 30px; width: 30px;" alt="Edit Entry" title="Edit Entry">
                                    </a>
                                </div>

                                @if (Model.Feedbacks != null && Model.Feedbacks.Any(i => i.CompetencyTrackerId == level.CompetencyTrackerId))
                                {
                                    // 1. Filter the feedback for the current specific tracker entry
                                    var detailFeedbacks = Model.Feedbacks
                                    .Where(i => i.CompetencyTrackerId == level.CompetencyTrackerId)
                                    .ToList();

                                    // 2. Project the data into a simpler format for JSON serialization
                                    var dataToSerialize = detailFeedbacks.Select(f => new
                                    {
                                        FeedbackText = f.FeedbackText,
                                        DateCreated = f.DateCreated.ToString("yyyy-MM-dd"),
                                        Reviewer = f.User != null ? f.User.FirstName + " " + f.User.LastName : "Unknown Reviewer"
                                    });

                                    // 3. Serialize the simplified data
                                    var jsonFeedbacks = System.Text.Json.JsonSerializer.Serialize(dataToSerialize);

                                    <div class="feedback-button-container">
                                        <button type="button"
                                                class="feedback-button"
                                                data-bs-toggle="modal"
                                                data-bs-target="#feedbackModal"
                                                data-goal-description="@comp.Description (Level: @level.Level.Name)"
                                                data-feedbacks="@jsonFeedbacks"
                                                title="View Feedback for this Entry">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-4z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                                        </button>
                                    </div>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            }
            else if (Model.From == null && Model.To == null)
            {
                <tbody class="master-row">
                    <tr>
                        <td>
                            @Html.DisplayFor(modelItem => comp.CompetencyDisplayId)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => comp.Description)
                        </td>
                        <td>
                            <a href="@Html.DisplayFor(modelItem => comp.LinkToIndicators)">Indicators</a>
                        </td>
                        <td>
                            <p>Emerging</p>
                        </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td>
                            <a asp-page="CreateCompetency" asp-route-competencyId="@comp.CompetencyId">
                                <img src="~/img/plus-black-symbol.png" style="height: 30px; width: 30px; margin-right: 13px;" alt="Edit Competency" title="Add Entry">
                            </a>
                        </td>
                        <td>
                        </td>
                    </tr>
                </tbody>
            }
        }
    }
</table>


@* 
    Checks if there are any discontinued competencies.
    Won't show discontinued competencies if trackers have been filtered
        to prevent confusion when the export page isn't filtered.
*@
@if (Model.DiscontinuedCompetencies.Count() > 0 && Model.From == null && Model.To == null)
{
    <p style="font-size: 18px; line-height: 1.75; font-weight: 600;"><br />These competencies have been discontinued.</p>

    <table class="table table-bordered table-striped collapsible-table">
        @foreach (var comp in Model.DiscontinuedCompetencies)
        {
            <thead>
                <tr>
                    <th>
                        @comp.CompetencyDisplayId
                    </th>
                    <th>
                        @comp.Description
                    </th>
                    <th>
                        <a href="@comp.LinkToIndicators">Indicators</a>
                    </th>
                    <th>
                        Level
                    </th>
                    <th>
                        Start Date
                    </th>
                    <th>
                        End Date
                    </th>
                    <th>
                        Skill Review
                    </th>
                    <th>
                        Evidence
                    </th>
                    <th></th>
                </tr>
            </thead>

            @foreach (var tracker in Model.DiscontinuedTrackers.Where(t => t.CompetencyId == comp.CompetencyId))
            {
                <tbody class="master-row">
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>
                            @tracker.Level.Name
                        </td>
                        <td>
                            @tracker.StartDate
                        </td>
                        <td>
                            @tracker.EndDate
                        </td>
                        <td>
                            @tracker.SkillsReview
                        </td>
                        <td>
                            <a href="@tracker.Evidence">Evidence</a>
                        </td>
                        <td>
                            <form asp-page-handler="Delete" method="post" asp-route-id="@tracker.CompetencyTrackerId" onsubmit="return confirm('Are you sure you want to delete this competency entry?');">
                                <button class="delete-button" type="submit" title="Delete Entry">
                                    <img src="~/img/garbage-bin-png-10491.png" style="height: 40px; width: 40px;" alt="Delete Entry">
                                </button>
                            </form>
                        </td>
                    </tr>
                </tbody>
            }
        }
    </table>

    <div class="d-flex align-items-center gap-3 mb-5">
        <p class="fw-bold mb-0 me-2">Go to this page to export your entries.</p>
        <a class="btn btn-warning w-auto d-inline-block" asp-page="/Export/ExportDiscontinuedTrackers">Export</a>
    </div>
}


<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="feedbackModalLabel">Feedback</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="feedbackContent">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        var iconUp = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V6M5 12l7-7 7 7"/></svg>';
        var iconDown = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v13M5 12l7 7 7-7"/></svg>';

        $('.collapsible-table').on('click', '.toggle-details', function () {
            var $button = $(this);
            var $masterRow = $button.closest('.master-row');
            var $detailRow = $masterRow.next('.collapsible-content');

            $detailRow.toggle(); // Toggles display: none and display: block
            $button.html($detailRow.is(':visible') ? iconUp : iconDown); // Changes arrow accordingly

        });

        $('.toggle-details').html(iconDown); // Initally sets all arrows to down
    });
</script>

<script>
    // Get the modal element
    var feedbackModal = document.getElementById('feedbackModal');

    // Check if the modal exists before adding the event listener
    if (feedbackModal) {

        // Listen for the 'show.bs.modal' event, which starts just before the modal is shown
        feedbackModal.addEventListener('show.bs.modal', function (event) {
            // Button that triggered the modal
            var button = event.relatedTarget;

            // Extract info from data attributes
            var feedbacksJson = button.getAttribute('data-feedbacks');

            // Parse the JSON string back into a JavaScript object (array)
            var feedbacks;
            try {
                feedbacks = JSON.parse(feedbacksJson);
            } catch (e) {
                console.error("Error parsing feedback JSON:", e);
                feedbacks = [];
            }

            // Prepare the content for the modal body
            var feedbackContent = feedbackModal.querySelector('#feedbackContent');
            feedbackContent.innerHTML = ''; // Clear previous content

            if (feedbacks.length > 0) {
                var htmlContent = '<div class="list-group">';

                feedbacks.forEach(function(feedback) {
                    htmlContent += '<div class="list-group-item list-group-item-action flex-column align-items-start">';
                    htmlContent += '  <div class="d-flex w-100 justify-content-between">';
                    htmlContent += '    <h5 class="mb-1 text-primary">Staff Member: ' + (feedback.Reviewer || 'N/A') + '</h5>';
                    htmlContent += '    <small class="text-muted">' + (feedback.DateCreated || 'N/A') + '</small>';
                    htmlContent += '  </div>';
                    htmlContent += '  <p class="mb-1">' + (feedback.FeedbackText || 'No feedback provided.') + '</p>';
                    htmlContent += '</div>';
                });

                htmlContent += '</div>';
                feedbackContent.innerHTML = htmlContent;

            } else {
                feedbackContent.innerHTML = '<p class="alert alert-info">No feedback available for this goal.</p>';
            }
        });
    }
</script>

